name: Flutter CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Create dummy .env file for testing
        run: |
          echo "VERYFI_API_KEY=dummy_key" > .env
          echo "VERYFI_CLIENT_ID=dummy_id" >> .env
          echo "VERYFI_USERNAME=dummy@example.com" >> .env
          echo "MINDEE_API_KEY=dummy_key" >> .env
          
      - name: Verify environment variables are accessible and non-empty
        run: |
          # Create a simple Dart script to check env vars
          echo 'import "package:flutter_dotenv/flutter_dotenv.dart";

          void main() async {
            await dotenv.load(fileName: ".env");
            
            // List of required environment variables
            final requiredVars = [
              "VERYFI_API_KEY",
              "VERYFI_CLIENT_ID",
              "VERYFI_USERNAME",
              "MINDEE_API_KEY",
            ];
            
            // Check each required variable
            final missingVars = <String>[];
            for (final varName in requiredVars) {
              final value = dotenv.env[varName];
              if (value == null || value.trim().isEmpty) {
                missingVars.add(varName);
              }
            }
            
            // Report any missing or empty variables
            if (missingVars.isNotEmpty) {
              print("ERROR: The following environment variables are missing or empty:");
              for (final varName in missingVars) {
                print("  - $varName");
              }
              throw Exception("Missing or empty environment variables");
            }
            
            print("All required environment variables are present and non-empty");
          }' > check_env.dart
          
          dart run check_env.dart
      
      - name: Verify formatting
        run: dart format --set-exit-if-changed .
      
      - name: Analyze project source
        run: flutter analyze
      
      - name: Run tests
        run: flutter test 